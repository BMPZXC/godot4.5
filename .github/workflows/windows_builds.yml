name: üèÅ Windows Builds (Custom - No 3D/Physics/XR)
on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    name: ${{ matrix.name }}
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Editor (MSVC)
            cache-name: windows-editor-no3d
            target: editor
            bin: ./bin/godot.windows.editor.x86_64.exe
            compiler: msvc

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore Godot build cache
        uses: ./.github/actions/godot-cache-restore
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Setup Python and SCons
        uses: ./.github/actions/godot-deps

      # ÂÖ≥ÈîÆÔºöÂú®Ê≠§Ê≠•È™§ÔºåÁõ¥Êé•‰ΩøÁî®Á°¨ÁºñÁ†ÅÁöÑÂÆåÊï¥ÂèÇÊï∞ÂàóË°®
      - name: Compilation
        uses: ./.github/actions/godot-build
        with:
          # Â∞ÜÊâÄÊúâSConsÂèÇÊï∞Áõ¥Êé•„ÄÅÂÆåÊï¥Âú∞ÂÜôÂú®ËøôÈáåÔºåÈÅøÂÖçÈÄöËøáenvÂèòÈáèÊãºÊé•
          scons-flags: >
            platform=windows
            target=${{ matrix.target }}
            dev_mode=yes
            debug_symbols=no
            d3d12=no
            disable_3d=yes
            disable_physics_3d=yes
            disable_xr=yes
            module_godot_physics_3d_enabled=no
            module_jolt_physics_enabled=no
            module_msdfgen_enabled=no
            "angle_libs=${{ github.workspace }}/"
            "accesskit_sdk_path=${{ github.workspace }}/accesskit-c-0.17.0/"
            windows_subsystem=console
            redirect_build_objects=no
          # Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÂºïÁî® env.SCONS_FLAGSÔºå‰πü‰∏çÊãºÊé• matrix.scons-flags

      - name: Save Godot build cache
        uses: ./.github/actions/godot-cache-save
        with:
          cache-name: ${{ matrix.cache-name }}
        continue-on-error: true

      - name: Prepare artifact
        run: |
          Remove-Item bin/* -Include *.exp,*.lib,*.pdb -Force

      - name: Upload artifact
        uses: ./.github/actions/upload-artifact
        with:
          name: ${{ matrix.cache-name }}

      - name: Basic test
        run: |
          ${{ matrix.bin }} --version
