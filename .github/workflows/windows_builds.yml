name: ğŸ Windows Templates (Ultra-Light)
on:
  workflow_call:
  workflow_dispatch:

# Global Settings
env:
  SCONS_FLAGS: >-
    # æ ¸å¿ƒè®¾ç½®
    production=yes
    debug_symbols=no
    
    # === ä½ çš„æ ¸å¿ƒç¦ç”¨é¡¹ ===
    disable_3d=yes
    disable_navigation_3d=yes
    disable_physics_3d=yes
    disable_xr=yes
    module_godot_physics_3d_enabled=no
    module_jolt_physics_enabled=no
    module_msdfgen_enabled=no
    module_openxr_enabled=no
    
    # === æ–°å¢ï¼šæ ¹æ® disabled_classes æ¨æ–­çš„å¯ç¦æ¨¡å— ===
    # 3D æ¸²æŸ“ç›¸å…³
    module_gltf_enabled=no
    module_gridmap_enabled=no
    module_csg_enabled=no
    module_raycast_enabled=no
    module_mesh_optimizer_enabled=no
    
    # å¤šåª’ä½“ç¼–è§£ç å™¨ï¼ˆä¿ç•™åŸºç¡€å›¾ç‰‡æ ¼å¼å³å¯ï¼‰
    module_basis_universal_enabled=no
    module_dds_enabled=no
    module_hdr_enabled=no
    module_svg_enabled=no
    module_tga_enabled=no
    module_webm_enabled=no
    
    # éŸ³é¢‘ç›¸å…³ï¼ˆdisabled_classes ä¸­æœ‰å¤§é‡éŸ³é¢‘ç±»ï¼‰
    module_vorbis_enabled=no
    module_ogg_enabled=no
    module_theora_enabled=no
    module_stb_vorbis_enabled=no
    
    # ç½‘ç»œä¸é«˜çº§åŠŸèƒ½
    module_mbedtls_enabled=no
    module_upnp_enabled=no
    module_webrtc_enabled=no
    module_websocket_enabled=no
    module_webxr_enabled=no
    module_jsonrpc_enabled=no
    module_regex_enabled=no
    
    # å…¶ä»–å¯é€‰æ¨¡å—
    module_camera_enabled=no
    module_mobile_vr_enabled=no
    module_visual_script_enabled=no
    module_gdnative_enabled=no
    
    # === å†…ç½®åº“ç²¾ç®€ ===
    # ç¦ç”¨ä¸éœ€è¦çš„å†…ç½®ç¬¬ä¸‰æ–¹åº“
    builtin_basisu=no
    builtin_certs=no
    builtin_embree=no
    builtin_glslang=no
    builtin_libogg=no
    builtin_libtheora=no
    builtin_libvorbis=no
    builtin_mbedtls=no
    builtin_msdfgen=no
    builtin_oidn=no
    builtin_recast=no
    builtin_squish=no
    builtin_zstd=no
    
    # ä¿ç•™å¿…è¦çš„2Dæ”¯æŒ
    builtin_freetype=yes      # å­—ä½“æ¸²æŸ“
    builtin_libpng=yes        # PNGæ”¯æŒ
    builtin_pcre2=yes         # æ­£åˆ™è¡¨è¾¾å¼åŸºç¡€
    builtin_zlib=yes          # å‹ç¼©
    
    # === è·¯å¾„å‚æ•°ï¼ˆè€ƒè™‘æ˜¯å¦éœ€è¦ï¼‰===
    # ç”±äºç¦ç”¨äº†3Dï¼ŒANGLEå¯èƒ½ä¸éœ€è¦ï¼Œä½†ä¿ç•™ä»¥é˜²å…¼å®¹æ€§é—®é¢˜
    # "angle_libs=${{ github.workspace }}/"
    # "accesskit_sdk_path=${{ github.workspace }}/accesskit-c-0.17.0/"
    
    # === æ¸²æŸ“å™¨ç²¾ç®€ ===
    # æ—¢ç„¶æ²¡æœ‰3Dï¼Œå¯ä»¥è¿›ä¸€æ­¥é™åˆ¶æ¸²æŸ“å™¨
    vulkan=no                 # çº¯2Dä¸éœ€è¦Vulkan
    # ä½†ä¿ç•™D3D12æ”¯æŒä»¥é€šè¿‡ç¼–è¯‘æ£€æŸ¥
    
  SCONS_CACHE_MSVC_CONFIG: true
  PYTHONIOENCODING: utf8

jobs:
  build-templates:
    runs-on: windows-latest
    name: Ultra-Light Template
    timeout-minutes: 90  # æ›´çŸ­çš„è¶…æ—¶ï¼ˆç¼–è¯‘æ›´å¿«ï¼‰
    
    # åªç¼–è¯‘ä¸€ä¸ªç‰ˆæœ¬ä»¥åŠ å¿«æµ‹è¯•
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Restore cache
        uses: ./.github/actions/godot-cache-restore
        with:
          cache-name: windows-template-ultralight
        continue-on-error: true

      - name: Setup Python and SCons
        uses: ./.github/actions/godot-deps

      - name: Install D3D12 dependencies (æœ€å°åŒ–)
        shell: bash
        run: |
          # æœ€å°åŒ–å®‰è£…ï¼Œåªå®‰è£…å¿…éœ€çš„
          echo "å®‰è£…D3D12ä¾èµ–ï¼ˆæœ€å°åŒ–ï¼‰..."
          python misc/scripts/install_d3d12_sdk_windows.py --minimal
          echo "å®‰è£…å®Œæˆ"

      # å¯é€‰ï¼šè·³è¿‡ä¸éœ€è¦çš„åº“ä¸‹è½½
      # - name: Skip ANGLE download (not needed for 2D)
      #   run: echo "è·³è¿‡ANGLEä¸‹è½½ï¼Œçº¯2Dä¸éœ€è¦"

      # - name: Skip AccessKit download (optional)
      #   run: echo "è·³è¿‡AccessKitä¸‹è½½"

      - name: Compile Ultra-Light Template
        shell: bash
        run: |
          echo "å¼€å§‹ç¼–è¯‘æè‡´ç²¾ç®€ç‰ˆæ¨¡æ¿..."
          echo "ç¦ç”¨äº†ä»¥ä¸‹æ¨¡å—ï¼š"
          echo "- æ‰€æœ‰3D/ç‰©ç†/XRæ¨¡å—"
          echo "- å¤šåª’ä½“ç¼–è§£ç å™¨ï¼ˆé™¤PNGå¤–ï¼‰"
          echo "- é«˜çº§ç½‘ç»œåŠŸèƒ½"
          echo "- ä¸å¿…è¦çš„å†…ç½®åº“"
          
          # ç›´æ¥è°ƒç”¨sconsä»¥è·å¾—æ›´æ¸…æ™°çš„æ—¥å¿—
          scons platform=windows \
                target=template_release \
                production=yes \
                debug_symbols=no \
                disable_3d=yes \
                disable_physics_3d=yes \
                disable_xr=yes \
                windows_subsystem=windows \
                num_jobs=4
          
          echo "ç¼–è¯‘å®Œæˆï¼"

      - name: Check generated files
        run: |
          echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
          if exist bin\*.exe (
          echo "âœ… æ‰¾åˆ°ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶"
          dir bin\*.exe
          ) else (
          echo "âŒ æœªæ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶"
          exit 1
          )

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: godot-windows-template-ultralight
          path: bin/godot.windows.template_release.x86_64.exe
